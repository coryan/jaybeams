language: cpp

dist: trusty
sudo: false

matrix:
  include:
    - os: linux
      compiler: clang
      env: LINUX_BUILD=yes DISTRO=fedora DISTRO_VERSION=24
    - os: linux
      compiler: gcc
      env: LINUX_BUILD=yes DISTRO=fedora DISTRO_VERSION=25 \
           CMAKE_FLAGS="-DCOVERAGE:BOOL=true -DCMAKE_BUILD_TYPE=Debug" BUILD_EXTRA=COVERAGE

#    - os: linux
#      compiler: gcc
#      env: IMAGE=coryan/jaybeamsdev-ubuntu16.04 COMPILER=g++ CXXFLAGS=-O3 CONFIGUREFLAGS="" CREATE_BUILD_IMAGE=yes CREATE_RUNTIME_IMAGE=yes CREATE_ANALYSIS_IMAGE=yes
#
#    - os: linux
#      compiler: gcc
#      env: IMAGE=coryan/jaybeamsdev-fedora25 COMPILER=g++ CXXFLAGS=-O3 GENDOCS=yes CONFIGUREFLAGS="" CREATE_BUILD_IMAGE=yes CREATE_RUNTIME_IMAGE=yes
#
#    - os: linux
#      compiler: gcc
#      env: IMAGE=coryan/jaybeamsdev-fedora25 COMPILER=clang++ CXXFLAGS="-O1 -g" CHECK_STYLE=yes CONFIGUREFLAGS="--with-sanitizer=address"
#
#    - os: linux
#      compiler: gcc
#      env: IMAGE=coryan/jaybeamsdev-ubuntu16.04 COMPILER=g++ CXXFLAGS="-O0 -g -coverage" COVERAGE=yes CONFIGUREFLAGS="" CREATE_BUILD_IMAGE=yes
#
#    - os: linux
#      compiler: gcc
#      env: IMAGE=coryan/jaybeamsdev-fedora24 COMPILER=clang++ CXXFLAGS=-O3 CONFIGUREFLAGS="" CREATE_BUILD_IMAGE=yes

services:
  - docker

# This is the main section of the automated build ...
script:
  - ci/build-linux.sh

after_success:
  - ci/upload-coverage.sh
  # ... if configured, run the style checker phase ...
  - ci/check-style.sh
  # ... create the Doxygen documentation inside the docker container,
  # and push it to github ...
  - ci/gendocs.sh
  # ... upload the coverity results ...
  - ci/coverity-upload.sh
  # ... on the right builds, create the build image and push to docker ...
  - ci/upload-build-image.sh
  # ... on the right builds, create the runtime image and push to docker ...
  - ci/create-runtime-image.sh
  # ... on the right builds, create the analysis image and push to docker ...
  - ci/create-analysis-image.sh

# Cache the (saved) docker images.
# With recent version of docker one can reuse a prior image as a
# source cache, that can speed up the builds, as the dependencies and
# images can be reused ...
# TODO() - we need to add a cron job to rebuild without a cache every
# so often, the dependencies do change and we want to validate that
# the examples build with the newer versions.  That is easy to do with
# a cron-based build in Travis that cleans up the cache every X days.
cache:
  directories:
    - coverity
    - docker-images/ubuntu/16.04
    - docker-images/ubuntu/17.04
    - docker-images/fedora/24
    - docker-images/fedora/25

before_cache:
  - ci/cache-linux.sh

install:
  - ci/install-linux.sh
  # ... if necessary, download Coverity ...
  - if [ "x${COVERITY}" = "xyes" ]; then ci/coverity-install.sh; fi

notifications:
  email: false
